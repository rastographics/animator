(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const h of document.querySelectorAll('link[rel="modulepreload"]'))A(h);new MutationObserver(h=>{for(const g of h)if(g.type==="childList")for(const P of g.addedNodes)P.tagName==="LINK"&&P.rel==="modulepreload"&&A(P)}).observe(document,{childList:!0,subtree:!0});function T(h){const g={};return h.integrity&&(g.integrity=h.integrity),h.referrerPolicy&&(g.referrerPolicy=h.referrerPolicy),h.crossOrigin==="use-credentials"?g.credentials="include":h.crossOrigin==="anonymous"?g.credentials="omit":g.credentials="same-origin",g}function A(h){if(h.ep)return;h.ep=!0;const g=T(h);fetch(h.href,g)}})();(()=>{const U=typeof window.showDirectoryPicker=="function",t={stream:null,facing:"environment",frames:[],thumbs:[],slideshowTimer:null,slideIndex:0,delay:500,stageSize:{w:1280,h:720},isPaused:!1,ghostOpacity:.5,ghostSecondLayerEnabled:!0,captureDir:null,captureMode:U?"disk":"memory",memoryNoticeShown:!1},T=[0,25,50,75,90],A=1,h=640,g="image/jpeg",P=.98,ve=30,d=e=>document.getElementById(e),m=d("cam"),D=d("camTap"),E=d("camHint"),v=d("stage"),V=v.getContext("2d"),k=d("slideshowTap"),_=d("slideshowHint"),be=d("btnFlip"),xe=d("btnClear"),Ee=d("btnExportGif"),Se=d("btnExportVideo"),ae=d("thumbs"),Ce=d("frameCount"),Me=d("status"),O=d("speedControl"),re=d("speedValue"),Ie=d("gifWidth"),ke=d("loops"),Fe=d("loopsVid"),Le=d("downloads"),S=d("ghostOpacityControl"),ne=d("ghostOpacityValue"),u=d("ghostOverlay"),F=u?u.getContext("2d"):null,B=d("ghostSecondLayerToggle"),l=e=>Me.textContent=e,q=()=>Ce.textContent=`${t.frames.length} frame${t.frames.length===1?"":"s"}`,W=(e,r,a,n)=>{const i=e/r,s=a/n;if(i>s){const o=a,c=Math.round(a/i);return{sx:0,sy:0,sw:e,sh:r,dx:0,dy:Math.round((n-c)/2),dw:o,dh:c}}else{const o=n,c=Math.round(n*i);return{sx:0,sy:0,sw:e,sh:r,dx:Math.round((a-c)/2),dy:0,dw:c,dh:o}}},ie=()=>{v&&(v.width=t.stageSize.w,v.height=t.stageSize.h,v.style.aspectRatio=`${t.stageSize.w} / ${t.stageSize.h}`,v.style.width="100%",v.style.height="auto")},j=()=>O?Math.max(100,Number(O.value)||500):500,K=()=>{const e=j();return re&&(re.textContent=`${e} ms`),e},C=()=>{if(!_||!k)return;const e=t.frames.length>=2,r=!!t.slideshowTimer;if(k.setAttribute("aria-pressed",r?"true":"false"),k.setAttribute("aria-disabled",e?"false":"true"),!e){_.textContent="Add 2+ frames to enable slideshow";return}_.textContent=r?"Tap preview to pause":"Paused — tap to resume"},Te=e=>Number.isFinite(e)?T.reduce((r,a)=>Math.abs(a-e)<Math.abs(r-e)?a:r,T[0]):T[0];function Pe(e,r=g,a=P){return new Promise((n,i)=>{e.toBlob(s=>{s?n(s):i(new Error("Could not create image blob."))},r,a)})}async function oe(e,r="readwrite"){if(!e||typeof e.queryPermission!="function")return!!e;const a={mode:r};try{return await e.queryPermission(a)==="granted"?!0:await e.requestPermission(a)==="granted"}catch(n){return console.warn("Permission check failed",n),!1}}function se(e,{notify:r=!1}={}){t.captureMode!=="memory"&&(t.captureMode="memory"),r&&!t.memoryNoticeShown&&(alert("Saving to disk is unavailable; snaps will stay in memory for this session."),t.memoryNoticeShown=!0),e&&l(e)}async function ce(){if(t.captureMode!=="disk")throw new Error("capture-mode-memory");if(t.captureDir&&await oe(t.captureDir))return t.captureDir;if(!U||typeof window.showDirectoryPicker!="function")throw new Error("directory-picker-unavailable");l("choose folder…");const e=await window.showDirectoryPicker({mode:"readwrite"});if(!await oe(e))throw new Error("directory-permission-denied");return t.captureDir=e,l("folder ready"),e}async function De(e,r){const a=r||await ce(),n=`frame_${Date.now()}_${Math.random().toString(16).slice(2)}.jpg`,i=await a.getFileHandle(n,{create:!0}),s=await i.createWritable();return await s.write(e),await s.close(),{fileHandle:i,filename:n}}async function Re(e){const{width:r,height:a}=e;if(!r||!a)return null;const i=Math.min(1,h/Math.max(r,a)),s=Math.max(1,Math.round(r*i)),o=Math.max(1,Math.round(a*i));if(i===1)return await createImageBitmap(e);if(typeof createImageBitmap=="function")try{return await createImageBitmap(e,{resizeWidth:s,resizeHeight:o,resizeQuality:"high"})}catch(x){console.warn("Resize via createImageBitmap failed, falling back to canvas scaling.",x)}const c=document.createElement("canvas");return c.width=s,c.height=o,c.getContext("2d").drawImage(e,0,0,s,o),await createImageBitmap(c)}function Y(e,r,a,n){if(!e||!r)return;r.fillStyle="#000",r.fillRect(0,0,a,n);const i=W(e.width,e.height,a,n);r.drawImage(e,i.sx,i.sy,i.sw,i.sh,i.dx,i.dy,i.dw,i.dh)}async function H(e){if(!e||!e.filename)return;const r=t.captureDir;if(!(!r||typeof r.removeEntry!="function"))try{await r.removeEntry(e.filename)}catch(a){console.warn("Unable to remove saved frame",a)}}async function de(){const e=[];let r=!1;for(const a of t.frames){let n=null,i=!1;if(a?.fileHandle?.getFile)try{const s=await a.fileHandle.getFile();n=await createImageBitmap(s),i=!0}catch(s){console.warn("Failed to load full-resolution frame from disk",s)}if(!n&&a?.memoryBlob)try{n=await createImageBitmap(a.memoryBlob),i=!0}catch(s){console.warn("Failed to recreate frame from in-memory blob",s)}!n&&a?.preview&&(n=a.preview,r=!0),n&&e.push({bmp:n,volatile:i})}return{entries:e,usedFallback:r}}const Q=()=>{!u||!m.videoWidth||!m.videoHeight||(u.width=m.videoWidth,u.height=m.videoHeight)},le=()=>{if(!D||!m||!m.videoWidth||!m.videoHeight)return;const e=`${m.videoWidth} / ${m.videoHeight}`;D.style.setProperty("--cam-ar",e),m.style.aspectRatio=e,u&&(u.style.aspectRatio=e)},M=()=>{if(!u||!F)return;const e=t.ghostOpacity,r=[],a=t.frames.length-1;if(t.ghostSecondLayerEnabled&&a-1>=0){const o=t.frames[a-1];o?.preview&&r.push({bmp:o.preview,opacity:Math.min(1,Math.max(0,e*A))})}if(a>=0){const o=t.frames[a];o?.preview&&r.push({bmp:o.preview,opacity:e})}if(!r.some(o=>o.opacity>0&&o.bmp)){F.clearRect(0,0,u.width||0,u.height||0),u.classList.add("opacity-0"),u.setAttribute("aria-hidden","true");return}(!u.width||!u.height)&&Q();const i=u.width||t.stageSize.w,s=u.height||t.stageSize.h;F.clearRect(0,0,i,s),r.forEach(o=>{if(!o.bmp)return;const c=W(o.bmp.width,o.bmp.height,i,s);F.globalAlpha=o.opacity,F.drawImage(o.bmp,c.sx,c.sy,c.sw,c.sh,c.dx,c.dy,c.dw,c.dh)}),F.globalAlpha=1,u.classList.remove("opacity-0"),u.removeAttribute("aria-hidden")};ie();async function X(){t.stream&&t.stream.getTracks().forEach(e=>e.stop());try{l("requesting camera…"),t.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:t.facing},width:{ideal:1280},height:{ideal:720}},audio:!1}),m.srcObject=t.stream,await m.play(),Q(),le(),M();const e=m.videoWidth||1280,r=m.videoHeight||720,n=Math.min(1,1280/Math.max(e,r));t.stageSize={w:Math.round(e*n)||1280,h:Math.round(r*n)||720},ie(),l("camera ready")}catch(e){console.error(e),l("camera error (check permissions/HTTPS)"),alert("Could not access camera. Ensure you are on HTTPS and granted permission.")}}function Ae(){t.facing=t.facing==="environment"?"user":"environment",X()}async function Oe(){if(!m.videoWidth)return;const e=document.createElement("canvas");e.width=m.videoWidth,e.height=m.videoHeight,e.getContext("2d",{willReadFrequently:!1}).drawImage(m,0,0);let a;try{a=await Pe(e)}catch(w){console.error("Failed to encode capture",w),alert("Unable to capture that frame. Please try again."),l("capture failed");return}let n=t.captureMode==="disk",i=null;if(n)try{i=await ce()}catch(w){if(w?.name==="AbortError"){l("folder required");return}console.warn("Capture folder unavailable; switching to memory mode.",w),n=!1,se("memory capture (disk unavailable)",{notify:!0})}let s=null;if(n&&i)try{s=await De(a,i)}catch(w){console.error("Failed to persist frame",w),n=!1,se("memory capture (disk write failed)",{notify:!0})}let o;try{o=await Re(e)}catch(w){console.error("Preview generation failed",w),alert("Unable to generate a preview for that snap."),l("preview error"),s?.filename&&await H(s);return}if(!o){s?.filename&&await H(s),alert("Preview frame missing; cannot continue.");return}const c={preview:o};n&&s?(c.fileHandle=s.fileHandle,c.filename=s.filename):c.memoryBlob=a,t.frames.push(c),t.frames.length===1&&E&&(E.classList.add("hidden"),E.setAttribute("aria-hidden","true"));const b=document.createElement("canvas");b.width=160,b.height=160;const x=b.getContext("2d"),y=W(o.width,o.height,160,160);x.fillStyle="#000",x.fillRect(0,0,160,160),x.drawImage(o,y.sx,y.sy,y.sw,y.sh,y.dx,y.dy,y.dw,y.dh);const I=b.toDataURL("image/jpeg",.9);t.thumbs.push(I),J(),q(),t.frames.length===1&&$(c),t.frames.length>=2&&R(),C(),M();const f=c.fileHandle?"saved to disk":"saved (memory only)";l(f)}function J(){ae.innerHTML="",t.thumbs.forEach((e,r)=>{const a=document.createElement("img");a.src=e,a.className="thumb w-full rounded-lg border border-white/10 cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-white/70",a.title=`Remove frame ${r+1}`,a.setAttribute("role","button"),a.tabIndex=0,a.setAttribute("aria-label",`Remove frame ${r+1}`);const n=()=>Be(r);a.addEventListener("click",n),a.addEventListener("keydown",i=>{(i.key==="Enter"||i.key===" "||i.key==="Spacebar")&&(i.preventDefault(),n())}),ae.appendChild(a)})}function Be(e){if(e<0||e>=t.frames.length)return;const r=!!t.slideshowTimer,[a]=t.frames.splice(e,1);if(a?.preview&&typeof a.preview.close=="function"&&a.preview.close(),a&&(a.memoryBlob=null),H(a),t.thumbs.splice(e,1),t.slideIndex>=t.frames.length&&(t.slideIndex=Math.max(0,t.frames.length-1)),q(),J(),t.frames.length===0)L(),V.clearRect(0,0,v.width,v.height),E&&(E.classList.remove("hidden"),E.removeAttribute("aria-hidden")),l("no frames");else{t.frames.length<2?L():r&&R(!0);const n=t.frames[t.slideIndex%t.frames.length];$(n),l("frame removed")}M(),C()}function $(e){const r=e?.preview||e;if(!r)return;const{w:a,h:n}=t.stageSize;Y(r,V,a,n)}function R(e=!1){L(!0);const r=K();t.delay=r,l(`slideshow ${r}ms`),e||(t.slideIndex=0),t.slideshowTimer=setInterval(()=>{if(t.frames.length===0)return;const a=t.frames[t.slideIndex%t.frames.length];$(a),t.slideIndex++},r),t.isPaused=!1,C()}function L(e=!1){t.slideshowTimer&&(clearInterval(t.slideshowTimer),t.slideshowTimer=null),e||(t.isPaused=!1),C()}function He(){L();const e=t.frames.slice();t.frames=[],t.thumbs=[],t.slideIndex=0,e.forEach(r=>{r?.preview&&typeof r.preview.close=="function"&&r.preview.close(),r&&(r.memoryBlob=null),H(r)}),q(),J(),V.clearRect(0,0,v.width,v.height),M(),E&&(E.classList.remove("hidden"),E.removeAttribute("aria-hidden")),l("cleared"),C()}function me(){if(!t.stream||!t.stream.active){X();return}Oe()}function $e(e){(e.key==="Enter"||e.key===" "||e.key==="Spacebar")&&(e.preventDefault(),me())}function Ne(){const e=K();t.delay=e,t.frames.length>=2&&t.slideshowTimer&&R(!0)}function Ge(){t.frames.length<2||(t.slideshowTimer?(L(!0),t.isPaused=!0,l("slideshow paused")):(t.isPaused=!1,R(!0)),C())}function fe(){t.frames.length<2||Ge()}function ze(e){(e.key==="Enter"||e.key===" "||e.key==="Spacebar")&&(e.preventDefault(),fe())}function Ue(){!ne||!S||(ne.textContent=`${S.value}%`)}function Z(){if(!S)return;const e=Te(Number(S.value)||0);S.value=e,t.ghostOpacity=e/100,Ue(),M()}function ue(){B&&(t.ghostSecondLayerEnabled=B.checked,M())}async function Ve(){if(t.frames.length===0){alert("Snap at least 1 frame first.");return}const e=j(),r=Math.max(1,Number(ke.value)||1),a=Math.max(64,Number(Ie.value)||640),{entries:n,usedFallback:i}=await de();if(!n.length){alert("Unable to load frames from disk.");return}const s=n[0].bmp,o=s.width/s.height||1,c=Math.max(1,Math.round(a/o));l("rendering GIF…");const b=document.createElement("canvas");b.width=a,b.height=c;const x=b.getContext("2d"),y=new GIF({workers:2,quality:10,workerScript:"assets/gif.worker.js",width:a,height:c}),I=()=>{n.forEach(f=>{f.volatile&&f.bmp?.close&&f.bmp.close()})};try{for(let f=0;f<r;f++)for(const w of n)Y(w.bmp,x,a,c),y.addFrame(x,{copy:!0,delay:e})}catch(f){I(),console.error("GIF export failed",f),alert("GIF export failed. See console for details."),l("GIF failed");return}y.on("finished",f=>{I();const w=URL.createObjectURL(f);qe(w,`slideshow_${Date.now()}.gif`),l(i?"GIF ready (preview fallback)":"GIF ready")}),y.render()}async function _e(){if(t.frames.length===0){alert("Snap at least 1 frame first.");return}const e=j(),r=ve,a=Math.max(1,Number(Fe.value)||1),n=t.frames.length*a;if(n===0){alert("No frames available for export.");return}const{entries:i,usedFallback:s}=await de();if(!i.length){alert("Unable to load frames from disk.");return}l("recording…");const o=!!t.slideshowTimer;L();const c=document.createElement("canvas");c.width=i[0].bmp.width,c.height=i[0].bmp.height;const b=c.getContext("2d"),x=c.captureStream(r),I=["video/mp4;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"].find(p=>MediaRecorder.isTypeSupported(p))||"",f=new MediaRecorder(x,I?{mimeType:I}:void 0),w=[];f.ondataavailable=p=>{p.data&&p.data.size&&w.push(p.data)};const We=new Promise((p,G)=>{f.onstop=p,f.onerror=z=>G(z.error||z)});f.start();const pe=Math.max(1,Math.round(e/1e3*r)),je=n*pe,we=i.map(p=>p.bmp),ge=()=>{i.forEach(p=>{p.volatile&&p.bmp?.close&&p.bmp.close()})};let ee=0;const Ke=Math.max(1,Math.round(1e3/r)),te=setInterval(()=>{const G=Math.floor(ee/pe)%we.length,z=we[G];Y(z,b,c.width,c.height);const ye=t.frames[G];ye&&$(ye),ee++,ee>=je&&(clearInterval(te),f.stop())},Ke);try{await We}catch(p){clearInterval(te),ge(),console.error("Video export failed",p),alert("Video export failed. See console for details."),l("video failed");return}clearInterval(te);const N=new Blob(w,{type:f.mimeType||"video/webm"}),Ye=/mp4/.test(N.type)?"mp4":"webm",Qe=URL.createObjectURL(N);he(Qe,`slideshow_${Date.now()}.${Ye}`,`${N.type} • ${(N.size/1024/1024).toFixed(2)} MB`),ge(),l(s?"video ready (preview fallback)":"video ready"),o&&t.frames.length>=2&&R()}function qe(e,r){he(e,r);const a=document.createElement("a");a.href=e,a.download=r,document.body.appendChild(a),a.click(),a.remove()}function he(e,r,a=""){const n=document.createElement("div");n.className="glass rounded-xl p-3 flex items-center justify-between";const i=document.createElement("div");i.innerHTML=`<div class="font-medium">${r}</div><div class="text-xs text-white/70">${a}</div>`;const s=document.createElement("div"),o=document.createElement("a");o.href=e,o.download=r,o.className="btn btn-primary",o.textContent="Download",s.appendChild(o),n.appendChild(i),n.appendChild(s),Le.prepend(n)}be.addEventListener("click",Ae),xe.addEventListener("click",He),D&&(D.addEventListener("click",me),D.addEventListener("keydown",$e)),O&&O.addEventListener("input",Ne),k&&(k.addEventListener("click",fe),k.addEventListener("keydown",ze)),S&&(S.addEventListener("input",Z),S.addEventListener("change",Z)),B&&B.addEventListener("change",ue),m&&m.addEventListener("loadedmetadata",()=>{le(),Q(),M()},{once:!1}),Ee.addEventListener("click",Ve),Se.addEventListener("click",_e),K(),C(),Z(),ue(),(async()=>{try{(await navigator.mediaDevices.enumerateDevices()).some(a=>a.kind==="videoinput")&&X()}catch{}})()})();
