(function(){const C=document.createElement("link").relList;if(C&&C.supports&&C.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))N(f);new MutationObserver(f=>{for(const g of f)if(g.type==="childList")for(const O of g.addedNodes)O.tagName==="LINK"&&O.rel==="modulepreload"&&N(O)}).observe(document,{childList:!0,subtree:!0});function L(f){const g={};return f.integrity&&(g.integrity=f.integrity),f.referrerPolicy&&(g.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?g.credentials="include":f.crossOrigin==="anonymous"?g.credentials="omit":g.credentials="same-origin",g}function N(f){if(f.ep)return;f.ep=!0;const g=L(f);fetch(f.href,g)}})();const tt=""+new URL("gif.worker-CjkyQP34.js",import.meta.url).href;"serviceWorker"in navigator&&window.addEventListener("load",()=>{try{const I=new URL("./",window.location.href),C=new URL("sw.js",I);navigator.serviceWorker.register(C.href,{scope:I.href}).catch(L=>{console.error("Service worker registration failed:",L)})}catch(I){console.error("Service worker registration error:",I)}});(()=>{const I=tt,C=typeof window.showDirectoryPicker=="function",L=[0,25,50,75,90],N=1,f=640,g="image/jpeg",O=.98,ke=30,B=100,ce=500,t={stream:null,facing:"environment",frames:[],thumbs:[],slideshowTimer:null,slideIndex:0,delay:B,stageSize:{w:1280,h:720},isPaused:!1,ghostOpacity:.5,ghostSecondLayerEnabled:!0,captureDir:null,captureMode:C?"disk":"memory",memoryNoticeShown:!1},d=e=>document.getElementById(e),m=d("cam"),$=d("camTap"),S=d("camHint"),b=d("stage"),K=b.getContext("2d"),T=d("slideshowTap"),Q=d("slideshowHint"),Me=d("btnFlip"),Ie=d("btnClear"),Le=d("btnExportGif"),Fe=d("btnExportVideo"),de=d("thumbs"),Pe=d("frameCount"),Te=d("status"),U=d("speedControl"),le=d("speedValue"),Re=d("gifWidth"),De=d("loops"),Ae=d("loopsVid"),me=d("gifCompression"),Oe=d("downloads"),k=d("ghostOpacityControl"),fe=d("ghostOpacityValue"),u=d("ghostOverlay"),R=u?u.getContext("2d"):null,_=d("ghostSecondLayerToggle"),l=e=>Te.textContent=e,X=()=>Pe.textContent=`${t.frames.length} frame${t.frames.length===1?"":"s"}`,J=(e,r,a,n)=>{const o=e/r,c=a/n;if(o>c){const i=a,s=Math.round(a/o);return{sx:0,sy:0,sw:e,sh:r,dx:0,dy:Math.round((n-s)/2),dw:i,dh:s}}else{const i=n,s=Math.round(n*o);return{sx:0,sy:0,sw:e,sh:r,dx:Math.round((a-s)/2),dy:0,dw:s,dh:i}}},ue=()=>{b&&(b.width=t.stageSize.w,b.height=t.stageSize.h,b.style.aspectRatio=`${t.stageSize.w} / ${t.stageSize.h}`,b.style.width="100%",b.style.height="auto")},Z=()=>{if(!U)return B;const e=Number(U.value);if(!Number.isFinite(e))return B;const r=Math.min(Math.max(e,B),ce);return B+ce-r},ee=()=>{const e=Z();return le&&(le.textContent=`${e} ms`),e},F=()=>{if(!Q||!T)return;const e=t.frames.length>=2,r=!!t.slideshowTimer;if(T.setAttribute("aria-pressed",r?"true":"false"),T.setAttribute("aria-disabled",e?"false":"true"),!e){Q.textContent="Add 2+ frames to enable slideshow";return}Q.textContent=r?"Tap preview to pause":"Paused — tap to resume"},Be=e=>Number.isFinite(e)?L.reduce((r,a)=>Math.abs(a-e)<Math.abs(r-e)?a:r,L[0]):L[0];function $e(e,r=g,a=O){return new Promise((n,o)=>{e.toBlob(c=>{c?n(c):o(new Error("Could not create image blob."))},r,a)})}async function he(e,r="readwrite"){if(!e||typeof e.queryPermission!="function")return!!e;const a={mode:r};try{return await e.queryPermission(a)==="granted"?!0:await e.requestPermission(a)==="granted"}catch(n){return console.warn("Permission check failed",n),!1}}function pe(e,{notify:r=!1}={}){t.captureMode!=="memory"&&(t.captureMode="memory"),r&&!t.memoryNoticeShown&&(alert("Saving to disk is unavailable; snaps will stay in memory for this session."),t.memoryNoticeShown=!0),e&&l(e)}async function we(){if(t.captureMode!=="disk")throw new Error("capture-mode-memory");if(t.captureDir&&await he(t.captureDir))return t.captureDir;if(!C||typeof window.showDirectoryPicker!="function")throw new Error("directory-picker-unavailable");l("choose folder…");const e=await window.showDirectoryPicker({mode:"readwrite"});if(!await he(e))throw new Error("directory-permission-denied");return t.captureDir=e,l("folder ready"),e}async function Ge(e,r){const a=r||await we(),n=`frame_${Date.now()}_${Math.random().toString(16).slice(2)}.jpg`,o=await a.getFileHandle(n,{create:!0}),c=await o.createWritable();return await c.write(e),await c.close(),{fileHandle:o,filename:n}}async function He(e){const{width:r,height:a}=e;if(!r||!a)return null;const o=Math.min(1,f/Math.max(r,a)),c=Math.max(1,Math.round(r*o)),i=Math.max(1,Math.round(a*o));if(o===1)return await createImageBitmap(e);if(typeof createImageBitmap=="function")try{return await createImageBitmap(e,{resizeWidth:c,resizeHeight:i,resizeQuality:"high"})}catch(x){console.warn("Resize via createImageBitmap failed, falling back to canvas scaling.",x)}const s=document.createElement("canvas");return s.width=c,s.height=i,s.getContext("2d").drawImage(e,0,0,c,i),await createImageBitmap(s)}function te(e,r,a,n){if(!e||!r)return;r.fillStyle="#000",r.fillRect(0,0,a,n);const o=J(e.width,e.height,a,n);r.drawImage(e,o.sx,o.sy,o.sw,o.sh,o.dx,o.dy,o.dw,o.dh)}async function z(e){if(!e||!e.filename)return;const r=t.captureDir;if(!(!r||typeof r.removeEntry!="function"))try{await r.removeEntry(e.filename)}catch(a){console.warn("Unable to remove saved frame",a)}}async function ge(e={}){const{preferPreviews:r=!1}=e,a=[];let n=!1,o=!1;for(const c of t.frames){let i=null,s=!1;if(r&&c?.preview&&(i=c.preview,o=!0),!i){if(c?.fileHandle?.getFile)try{const p=await c.fileHandle.getFile();i=await createImageBitmap(p),s=!0}catch(p){console.warn("Failed to load full-resolution frame from disk",p)}if(!i&&c?.memoryBlob)try{i=await createImageBitmap(c.memoryBlob),s=!0}catch(p){console.warn("Failed to recreate frame from in-memory blob",p)}}!i&&c?.preview&&(i=c.preview,n=!0),i&&a.push({bmp:i,volatile:s})}return{entries:a,usedFallback:n,usedPreview:o}}const re=()=>{!u||!m.videoWidth||!m.videoHeight||(u.width=m.videoWidth,u.height=m.videoHeight)},ve=()=>{if(!$||!m||!m.videoWidth||!m.videoHeight)return;const e=`${m.videoWidth} / ${m.videoHeight}`;$.style.setProperty("--cam-ar",e),m.style.aspectRatio=e,u&&(u.style.aspectRatio=e)},P=()=>{if(!u||!R)return;const e=t.ghostOpacity,r=[],a=t.frames.length-1;if(t.ghostSecondLayerEnabled&&a-1>=0){const i=t.frames[a-1];i?.preview&&r.push({bmp:i.preview,opacity:Math.min(1,Math.max(0,e*N))})}if(a>=0){const i=t.frames[a];i?.preview&&r.push({bmp:i.preview,opacity:e})}if(!r.some(i=>i.opacity>0&&i.bmp)){R.clearRect(0,0,u.width||0,u.height||0),u.classList.add("opacity-0"),u.setAttribute("aria-hidden","true");return}(!u.width||!u.height)&&re();const o=u.width||t.stageSize.w,c=u.height||t.stageSize.h;R.clearRect(0,0,o,c),r.forEach(i=>{if(!i.bmp)return;const s=J(i.bmp.width,i.bmp.height,o,c);R.globalAlpha=i.opacity,R.drawImage(i.bmp,s.sx,s.sy,s.sw,s.sh,s.dx,s.dy,s.dw,s.dh)}),R.globalAlpha=1,u.classList.remove("opacity-0"),u.removeAttribute("aria-hidden")};ue();async function ae(){t.stream&&t.stream.getTracks().forEach(e=>e.stop());try{l("requesting camera…"),t.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:t.facing},width:{ideal:1280},height:{ideal:720}},audio:!1}),m.srcObject=t.stream,await m.play(),re(),ve(),P();const e=m.videoWidth||1280,r=m.videoHeight||720,n=Math.min(1,1280/Math.max(e,r));t.stageSize={w:Math.round(e*n)||1280,h:Math.round(r*n)||720},ue(),l("camera ready")}catch(e){console.error(e),l("camera error (check permissions/HTTPS)"),alert("Could not access camera. Ensure you are on HTTPS and granted permission.")}}function Ne(){t.facing=t.facing==="environment"?"user":"environment",ae()}async function Ue(){if(!m.videoWidth)return;const e=document.createElement("canvas");e.width=m.videoWidth,e.height=m.videoHeight,e.getContext("2d",{willReadFrequently:!1}).drawImage(m,0,0);let a;try{a=await $e(e)}catch(w){console.error("Failed to encode capture",w),alert("Unable to capture that frame. Please try again."),l("capture failed");return}let n=t.captureMode==="disk",o=null;if(n)try{o=await we()}catch(w){if(w?.name==="AbortError"){l("folder required");return}console.warn("Capture folder unavailable; switching to memory mode.",w),n=!1,pe("memory capture (disk unavailable)",{notify:!0})}let c=null;if(n&&o)try{c=await Ge(a,o)}catch(w){console.error("Failed to persist frame",w),n=!1,pe("memory capture (disk write failed)",{notify:!0})}let i;try{i=await He(e)}catch(w){console.error("Preview generation failed",w),alert("Unable to generate a preview for that snap."),l("preview error"),c?.filename&&await z(c);return}if(!i){c?.filename&&await z(c),alert("Preview frame missing; cannot continue.");return}const s={preview:i};n&&c?(s.fileHandle=c.fileHandle,s.filename=c.filename):s.memoryBlob=a,t.frames.push(s),t.frames.length===1&&S&&(S.classList.add("hidden"),S.setAttribute("aria-hidden","true"));const p=document.createElement("canvas");p.width=160,p.height=160;const x=p.getContext("2d"),v=J(i.width,i.height,160,160);x.fillStyle="#000",x.fillRect(0,0,160,160),x.drawImage(i,v.sx,v.sy,v.sw,v.sh,v.dx,v.dy,v.dw,v.dh);const M=p.toDataURL("image/jpeg",.9);t.thumbs.push(M),oe(),X(),t.frames.length===1&&W(s),t.frames.length>=2&&G(),F(),P();const E=s.fileHandle?"saved to disk":"saved (memory only)";l(E)}function oe(){de.innerHTML="",t.thumbs.forEach((e,r)=>{const a=document.createElement("img");a.src=e,a.className="thumb w-full rounded-lg border border-white/10 cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-white/70",a.title=`Remove frame ${r+1}`,a.setAttribute("role","button"),a.tabIndex=0,a.setAttribute("aria-label",`Remove frame ${r+1}`);const n=()=>_e(r);a.addEventListener("click",n),a.addEventListener("keydown",o=>{(o.key==="Enter"||o.key===" "||o.key==="Spacebar")&&(o.preventDefault(),n())}),de.appendChild(a)})}function _e(e){if(e<0||e>=t.frames.length)return;const r=!!t.slideshowTimer,[a]=t.frames.splice(e,1);if(a?.preview&&typeof a.preview.close=="function"&&a.preview.close(),a&&(a.memoryBlob=null),z(a),t.thumbs.splice(e,1),t.slideIndex>=t.frames.length&&(t.slideIndex=Math.max(0,t.frames.length-1)),X(),oe(),t.frames.length===0)D(),K.clearRect(0,0,b.width,b.height),S&&(S.classList.remove("hidden"),S.removeAttribute("aria-hidden")),l("no frames");else{t.frames.length<2?D():r&&G(!0);const n=t.frames[t.slideIndex%t.frames.length];W(n),l("frame removed")}P(),F()}function W(e){const r=e?.preview||e;if(!r)return;const{w:a,h:n}=t.stageSize;te(r,K,a,n)}function G(e=!1){D(!0);const r=ee();t.delay=r,l(`slideshow ${r}ms`),e||(t.slideIndex=0),t.slideshowTimer=setInterval(()=>{if(t.frames.length===0)return;const a=t.frames[t.slideIndex%t.frames.length];W(a),t.slideIndex++},r),t.isPaused=!1,F()}function D(e=!1){t.slideshowTimer&&(clearInterval(t.slideshowTimer),t.slideshowTimer=null),e||(t.isPaused=!1),F()}function ze(){D();const e=t.frames.slice();t.frames=[],t.thumbs=[],t.slideIndex=0,e.forEach(r=>{r?.preview&&typeof r.preview.close=="function"&&r.preview.close(),r&&(r.memoryBlob=null),z(r)}),X(),oe(),K.clearRect(0,0,b.width,b.height),P(),S&&(S.classList.remove("hidden"),S.removeAttribute("aria-hidden")),l("cleared"),F()}function ye(){if(!t.stream||!t.stream.active){ae();return}Ue()}function We(e){(e.key==="Enter"||e.key===" "||e.key==="Spacebar")&&(e.preventDefault(),ye())}function Ve(){const e=ee();t.delay=e,t.frames.length>=2&&t.slideshowTimer&&G(!0)}function je(){t.frames.length<2||(t.slideshowTimer?(D(!0),t.isPaused=!0,l("slideshow paused")):(t.isPaused=!1,G(!0)),F())}function be(){t.frames.length<2||je()}function qe(e){(e.key==="Enter"||e.key===" "||e.key==="Spacebar")&&(e.preventDefault(),be())}function Ye(){!fe||!k||(fe.textContent=`${k.value}%`)}function ie(){if(!k)return;const e=Be(Number(k.value)||0);k.value=e,t.ghostOpacity=e/100,Ye(),P()}function xe(){_&&(t.ghostSecondLayerEnabled=_.checked,P())}async function Ke(){if(t.frames.length===0){alert("Snap at least 1 frame first.");return}const e=Z(),r=Math.max(1,Number(De.value)||1),a=Math.max(64,Number(Re.value)||640),n=a<=f,{entries:o,usedFallback:c,usedPreview:i}=await ge({preferPreviews:n});if(!o.length){alert("Unable to load frames from disk.");return}const s=o[0].bmp,p=s.width/s.height||1,x=Math.max(1,Math.round(a/p)),v=me&&me.checked;l(v?"rendering GIF (compressed)…":"rendering GIF…");const M=document.createElement("canvas");M.width=a,M.height=x;const E=M.getContext("2d"),w=new GIF({workers:2,quality:10,workerScript:I,width:a,height:x,...v&&{dither:"FloydSteinberg",globalPalette:!0}}),V=()=>{o.forEach(y=>{y.volatile&&y.bmp?.close&&y.bmp.close()})};try{for(let y=0;y<r;y++)for(const H of o)te(H.bmp,E,a,x),w.addFrame(E,{copy:!0,delay:e})}catch(y){V(),console.error("GIF export failed",y),alert("GIF export failed. See console for details."),l("GIF failed");return}w.on("finished",y=>{V();const H=URL.createObjectURL(y);Xe(H,`slideshow_${Date.now()}.gif`);const A=v?" (compressed)":"";l(c?`GIF ready (preview fallback${A})`:i?`GIF ready (preview source${A})`:`GIF ready${A}`)}),w.render()}async function Qe(){if(t.frames.length===0){alert("Snap at least 1 frame first.");return}const e=Z(),r=ke,a=Math.max(1,Number(Ae.value)||1),n=t.frames.length*a;if(n===0){alert("No frames available for export.");return}const{entries:o,usedFallback:c}=await ge();if(!o.length){alert("Unable to load frames from disk.");return}l("recording…");const i=!!t.slideshowTimer;D();const s=document.createElement("canvas");s.width=o[0].bmp.width,s.height=o[0].bmp.height;const p=s.getContext("2d"),x=s.captureStream(r),M=["video/mp4;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"].find(h=>MediaRecorder.isTypeSupported(h))||"",E=new MediaRecorder(x,M?{mimeType:M}:void 0),w=[];E.ondataavailable=h=>{h.data&&h.data.size&&w.push(h.data)};const V=new Promise((h,q)=>{E.onstop=h,E.onerror=Y=>q(Y.error||Y)});E.start();const y=Math.max(1,Math.round(e/1e3*r)),H=n*y,A=o.map(h=>h.bmp),Se=()=>{o.forEach(h=>{h.volatile&&h.bmp?.close&&h.bmp.close()})};let ne=0;const Je=Math.max(1,Math.round(1e3/r)),se=setInterval(()=>{const q=Math.floor(ne/y)%A.length,Y=A[q];te(Y,p,s.width,s.height);const Ce=t.frames[q];Ce&&W(Ce),ne++,ne>=H&&(clearInterval(se),E.stop())},Je);try{await V}catch(h){clearInterval(se),Se(),console.error("Video export failed",h),alert("Video export failed. See console for details."),l("video failed");return}clearInterval(se);const j=new Blob(w,{type:E.mimeType||"video/webm"}),Ze=/mp4/.test(j.type)?"mp4":"webm",et=URL.createObjectURL(j);Ee(et,`slideshow_${Date.now()}.${Ze}`,`${j.type} • ${(j.size/1024/1024).toFixed(2)} MB`),Se(),l(c?"video ready (preview fallback)":"video ready"),i&&t.frames.length>=2&&G()}function Xe(e,r){Ee(e,r);const a=document.createElement("a");a.href=e,a.download=r,document.body.appendChild(a),a.click(),a.remove()}function Ee(e,r,a=""){const n=document.createElement("div");n.className="glass rounded-xl p-3 flex items-center justify-between";const o=document.createElement("div");o.innerHTML=`<div class="font-medium">${r}</div><div class="text-xs text-white/70">${a}</div>`;const c=document.createElement("div"),i=document.createElement("a");i.href=e,i.download=r,i.className="btn btn-primary",i.textContent="Download",c.appendChild(i),n.appendChild(o),n.appendChild(c),Oe.prepend(n)}Me.addEventListener("click",Ne),Ie.addEventListener("click",ze),$&&($.addEventListener("click",ye),$.addEventListener("keydown",We)),U&&U.addEventListener("input",Ve),T&&(T.addEventListener("click",be),T.addEventListener("keydown",qe)),k&&(k.addEventListener("input",ie),k.addEventListener("change",ie)),_&&_.addEventListener("change",xe),m&&m.addEventListener("loadedmetadata",()=>{ve(),re(),P()},{once:!1}),Le.addEventListener("click",Ke),Fe.addEventListener("click",Qe),ee(),F(),ie(),xe(),(async()=>{try{(await navigator.mediaDevices.enumerateDevices()).some(a=>a.kind==="videoinput")&&ae()}catch{}})()})();
