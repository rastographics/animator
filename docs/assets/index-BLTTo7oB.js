(function(){const M=document.createElement("link").relList;if(M&&M.supports&&M.supports("modulepreload"))return;for(const m of document.querySelectorAll('link[rel="modulepreload"]'))N(m);new MutationObserver(m=>{for(const g of m)if(g.type==="childList")for(const O of g.addedNodes)O.tagName==="LINK"&&O.rel==="modulepreload"&&N(O)}).observe(document,{childList:!0,subtree:!0});function I(m){const g={};return m.integrity&&(g.integrity=m.integrity),m.referrerPolicy&&(g.referrerPolicy=m.referrerPolicy),m.crossOrigin==="use-credentials"?g.credentials="include":m.crossOrigin==="anonymous"?g.credentials="omit":g.credentials="same-origin",g}function N(m){if(m.ep)return;m.ep=!0;const g=I(m);fetch(m.href,g)}})();const et=""+new URL("gif.worker-CjkyQP34.js",import.meta.url).href;"serviceWorker"in navigator&&window.addEventListener("load",()=>{try{const C=new URL("./",window.location.href),M=new URL("sw.js",C);navigator.serviceWorker.register(M.href,{scope:C.href}).catch(I=>{console.error("Service worker registration failed:",I)})}catch(C){console.error("Service worker registration error:",C)}});(()=>{const C=et,M=typeof window.showDirectoryPicker=="function",I=[0,25,50,75,90],N=1,m=640,g="image/jpeg",O=.98,Se=30,B=100,ne=500,t={stream:null,facing:"environment",frames:[],thumbs:[],slideshowTimer:null,slideIndex:0,delay:B,stageSize:{w:1280,h:720},isPaused:!1,ghostOpacity:.5,ghostSecondLayerEnabled:!0,captureDir:null,captureMode:M?"disk":"memory",memoryNoticeShown:!1},l=e=>document.getElementById(e),f=l("cam"),H=l("camTap"),S=l("camHint"),x=l("stage"),q=x.getContext("2d"),T=l("slideshowTap"),Y=l("slideshowHint"),Me=l("btnFlip"),ke=l("btnClear"),Ce=l("btnExportGif"),Ie=l("btnExportVideo"),se=l("thumbs"),Le=l("frameCount"),Fe=l("status"),U=l("speedControl"),ce=l("speedValue"),Pe=l("gifWidth"),Te=l("loops"),Re=l("loopsVid"),De=l("downloads"),k=l("ghostOpacityControl"),le=l("ghostOpacityValue"),u=l("ghostOverlay"),R=u?u.getContext("2d"):null,$=l("ghostSecondLayerToggle"),d=e=>Fe.textContent=e,K=()=>Le.textContent=`${t.frames.length} frame${t.frames.length===1?"":"s"}`,Q=(e,r,a,n)=>{const i=e/r,c=a/n;if(i>c){const o=a,s=Math.round(a/i);return{sx:0,sy:0,sw:e,sh:r,dx:0,dy:Math.round((n-s)/2),dw:o,dh:s}}else{const o=n,s=Math.round(n*i);return{sx:0,sy:0,sw:e,sh:r,dx:Math.round((a-s)/2),dy:0,dw:s,dh:o}}},de=()=>{x&&(x.width=t.stageSize.w,x.height=t.stageSize.h,x.style.aspectRatio=`${t.stageSize.w} / ${t.stageSize.h}`,x.style.width="100%",x.style.height="auto")},X=()=>{if(!U)return B;const e=Number(U.value);if(!Number.isFinite(e))return B;const r=Math.min(Math.max(e,B),ne);return B+ne-r},J=()=>{const e=X();return ce&&(ce.textContent=`${e} ms`),e},L=()=>{if(!Y||!T)return;const e=t.frames.length>=2,r=!!t.slideshowTimer;if(T.setAttribute("aria-pressed",r?"true":"false"),T.setAttribute("aria-disabled",e?"false":"true"),!e){Y.textContent="Add 2+ frames to enable slideshow";return}Y.textContent=r?"Tap preview to pause":"Paused — tap to resume"},Ae=e=>Number.isFinite(e)?I.reduce((r,a)=>Math.abs(a-e)<Math.abs(r-e)?a:r,I[0]):I[0];function Oe(e,r=g,a=O){return new Promise((n,i)=>{e.toBlob(c=>{c?n(c):i(new Error("Could not create image blob."))},r,a)})}async function fe(e,r="readwrite"){if(!e||typeof e.queryPermission!="function")return!!e;const a={mode:r};try{return await e.queryPermission(a)==="granted"?!0:await e.requestPermission(a)==="granted"}catch(n){return console.warn("Permission check failed",n),!1}}function me(e,{notify:r=!1}={}){t.captureMode!=="memory"&&(t.captureMode="memory"),r&&!t.memoryNoticeShown&&(alert("Saving to disk is unavailable; snaps will stay in memory for this session."),t.memoryNoticeShown=!0),e&&d(e)}async function ue(){if(t.captureMode!=="disk")throw new Error("capture-mode-memory");if(t.captureDir&&await fe(t.captureDir))return t.captureDir;if(!M||typeof window.showDirectoryPicker!="function")throw new Error("directory-picker-unavailable");d("choose folder…");const e=await window.showDirectoryPicker({mode:"readwrite"});if(!await fe(e))throw new Error("directory-permission-denied");return t.captureDir=e,d("folder ready"),e}async function Be(e,r){const a=r||await ue(),n=`frame_${Date.now()}_${Math.random().toString(16).slice(2)}.jpg`,i=await a.getFileHandle(n,{create:!0}),c=await i.createWritable();return await c.write(e),await c.close(),{fileHandle:i,filename:n}}async function He(e){const{width:r,height:a}=e;if(!r||!a)return null;const i=Math.min(1,m/Math.max(r,a)),c=Math.max(1,Math.round(r*i)),o=Math.max(1,Math.round(a*i));if(i===1)return await createImageBitmap(e);if(typeof createImageBitmap=="function")try{return await createImageBitmap(e,{resizeWidth:c,resizeHeight:o,resizeQuality:"high"})}catch(E){console.warn("Resize via createImageBitmap failed, falling back to canvas scaling.",E)}const s=document.createElement("canvas");return s.width=c,s.height=o,s.getContext("2d").drawImage(e,0,0,c,o),await createImageBitmap(s)}function Z(e,r,a,n){if(!e||!r)return;r.fillStyle="#000",r.fillRect(0,0,a,n);const i=Q(e.width,e.height,a,n);r.drawImage(e,i.sx,i.sy,i.sw,i.sh,i.dx,i.dy,i.dw,i.dh)}async function _(e){if(!e||!e.filename)return;const r=t.captureDir;if(!(!r||typeof r.removeEntry!="function"))try{await r.removeEntry(e.filename)}catch(a){console.warn("Unable to remove saved frame",a)}}async function he(e={}){const{preferPreviews:r=!1}=e,a=[];let n=!1,i=!1;for(const c of t.frames){let o=null,s=!1;if(r&&c?.preview&&(o=c.preview,i=!0),!o){if(c?.fileHandle?.getFile)try{const p=await c.fileHandle.getFile();o=await createImageBitmap(p),s=!0}catch(p){console.warn("Failed to load full-resolution frame from disk",p)}if(!o&&c?.memoryBlob)try{o=await createImageBitmap(c.memoryBlob),s=!0}catch(p){console.warn("Failed to recreate frame from in-memory blob",p)}}!o&&c?.preview&&(o=c.preview,n=!0),o&&a.push({bmp:o,volatile:s})}return{entries:a,usedFallback:n,usedPreview:i}}const ee=()=>{!u||!f.videoWidth||!f.videoHeight||(u.width=f.videoWidth,u.height=f.videoHeight)},pe=()=>{if(!H||!f||!f.videoWidth||!f.videoHeight)return;const e=`${f.videoWidth} / ${f.videoHeight}`;H.style.setProperty("--cam-ar",e),f.style.aspectRatio=e,u&&(u.style.aspectRatio=e)},F=()=>{if(!u||!R)return;const e=t.ghostOpacity,r=[],a=t.frames.length-1;if(t.ghostSecondLayerEnabled&&a-1>=0){const o=t.frames[a-1];o?.preview&&r.push({bmp:o.preview,opacity:Math.min(1,Math.max(0,e*N))})}if(a>=0){const o=t.frames[a];o?.preview&&r.push({bmp:o.preview,opacity:e})}if(!r.some(o=>o.opacity>0&&o.bmp)){R.clearRect(0,0,u.width||0,u.height||0),u.classList.add("opacity-0"),u.setAttribute("aria-hidden","true");return}(!u.width||!u.height)&&ee();const i=u.width||t.stageSize.w,c=u.height||t.stageSize.h;R.clearRect(0,0,i,c),r.forEach(o=>{if(!o.bmp)return;const s=Q(o.bmp.width,o.bmp.height,i,c);R.globalAlpha=o.opacity,R.drawImage(o.bmp,s.sx,s.sy,s.sw,s.sh,s.dx,s.dy,s.dw,s.dh)}),R.globalAlpha=1,u.classList.remove("opacity-0"),u.removeAttribute("aria-hidden")};de();async function te(){t.stream&&t.stream.getTracks().forEach(e=>e.stop());try{d("requesting camera…"),t.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:t.facing},width:{ideal:1280},height:{ideal:720}},audio:!1}),f.srcObject=t.stream,await f.play(),ee(),pe(),F();const e=f.videoWidth||1280,r=f.videoHeight||720,n=Math.min(1,1280/Math.max(e,r));t.stageSize={w:Math.round(e*n)||1280,h:Math.round(r*n)||720},de(),d("camera ready")}catch(e){console.error(e),d("camera error (check permissions/HTTPS)"),alert("Could not access camera. Ensure you are on HTTPS and granted permission.")}}function Ge(){t.facing=t.facing==="environment"?"user":"environment",te()}async function Ne(){if(!f.videoWidth)return;const e=document.createElement("canvas");e.width=f.videoWidth,e.height=f.videoHeight,e.getContext("2d",{willReadFrequently:!1}).drawImage(f,0,0);let a;try{a=await Oe(e)}catch(w){console.error("Failed to encode capture",w),alert("Unable to capture that frame. Please try again."),d("capture failed");return}let n=t.captureMode==="disk",i=null;if(n)try{i=await ue()}catch(w){if(w?.name==="AbortError"){d("folder required");return}console.warn("Capture folder unavailable; switching to memory mode.",w),n=!1,me("memory capture (disk unavailable)",{notify:!0})}let c=null;if(n&&i)try{c=await Be(a,i)}catch(w){console.error("Failed to persist frame",w),n=!1,me("memory capture (disk write failed)",{notify:!0})}let o;try{o=await He(e)}catch(w){console.error("Preview generation failed",w),alert("Unable to generate a preview for that snap."),d("preview error"),c?.filename&&await _(c);return}if(!o){c?.filename&&await _(c),alert("Preview frame missing; cannot continue.");return}const s={preview:o};n&&c?(s.fileHandle=c.fileHandle,s.filename=c.filename):s.memoryBlob=a,t.frames.push(s),t.frames.length===1&&S&&(S.classList.add("hidden"),S.setAttribute("aria-hidden","true"));const p=document.createElement("canvas");p.width=160,p.height=160;const E=p.getContext("2d"),v=Q(o.width,o.height,160,160);E.fillStyle="#000",E.fillRect(0,0,160,160),E.drawImage(o,v.sx,v.sy,v.sw,v.sh,v.dx,v.dy,v.dw,v.dh);const P=p.toDataURL("image/jpeg",.9);t.thumbs.push(P),re(),K(),t.frames.length===1&&z(s),t.frames.length>=2&&G(),L(),F();const y=s.fileHandle?"saved to disk":"saved (memory only)";d(y)}function re(){se.innerHTML="",t.thumbs.forEach((e,r)=>{const a=document.createElement("img");a.src=e,a.className="thumb w-full rounded-lg border border-white/10 cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-white/70",a.title=`Remove frame ${r+1}`,a.setAttribute("role","button"),a.tabIndex=0,a.setAttribute("aria-label",`Remove frame ${r+1}`);const n=()=>Ue(r);a.addEventListener("click",n),a.addEventListener("keydown",i=>{(i.key==="Enter"||i.key===" "||i.key==="Spacebar")&&(i.preventDefault(),n())}),se.appendChild(a)})}function Ue(e){if(e<0||e>=t.frames.length)return;const r=!!t.slideshowTimer,[a]=t.frames.splice(e,1);if(a?.preview&&typeof a.preview.close=="function"&&a.preview.close(),a&&(a.memoryBlob=null),_(a),t.thumbs.splice(e,1),t.slideIndex>=t.frames.length&&(t.slideIndex=Math.max(0,t.frames.length-1)),K(),re(),t.frames.length===0)D(),q.clearRect(0,0,x.width,x.height),S&&(S.classList.remove("hidden"),S.removeAttribute("aria-hidden")),d("no frames");else{t.frames.length<2?D():r&&G(!0);const n=t.frames[t.slideIndex%t.frames.length];z(n),d("frame removed")}F(),L()}function z(e){const r=e?.preview||e;if(!r)return;const{w:a,h:n}=t.stageSize;Z(r,q,a,n)}function G(e=!1){D(!0);const r=J();t.delay=r,d(`slideshow ${r}ms`),e||(t.slideIndex=0),t.slideshowTimer=setInterval(()=>{if(t.frames.length===0)return;const a=t.frames[t.slideIndex%t.frames.length];z(a),t.slideIndex++},r),t.isPaused=!1,L()}function D(e=!1){t.slideshowTimer&&(clearInterval(t.slideshowTimer),t.slideshowTimer=null),e||(t.isPaused=!1),L()}function $e(){D();const e=t.frames.slice();t.frames=[],t.thumbs=[],t.slideIndex=0,e.forEach(r=>{r?.preview&&typeof r.preview.close=="function"&&r.preview.close(),r&&(r.memoryBlob=null),_(r)}),K(),re(),q.clearRect(0,0,x.width,x.height),F(),S&&(S.classList.remove("hidden"),S.removeAttribute("aria-hidden")),d("cleared"),L()}function we(){if(!t.stream||!t.stream.active){te();return}Ne()}function _e(e){(e.key==="Enter"||e.key===" "||e.key==="Spacebar")&&(e.preventDefault(),we())}function ze(){const e=J();t.delay=e,t.frames.length>=2&&t.slideshowTimer&&G(!0)}function We(){t.frames.length<2||(t.slideshowTimer?(D(!0),t.isPaused=!0,d("slideshow paused")):(t.isPaused=!1,G(!0)),L())}function ge(){t.frames.length<2||We()}function Ve(e){(e.key==="Enter"||e.key===" "||e.key==="Spacebar")&&(e.preventDefault(),ge())}function je(){!le||!k||(le.textContent=`${k.value}%`)}function ae(){if(!k)return;const e=Ae(Number(k.value)||0);k.value=e,t.ghostOpacity=e/100,je(),F()}function ve(){$&&(t.ghostSecondLayerEnabled=$.checked,F())}async function qe(){if(t.frames.length===0){alert("Snap at least 1 frame first.");return}const e=X(),r=Math.max(1,Number(Te.value)||1),a=Math.max(64,Number(Pe.value)||640),n=a<=m,{entries:i,usedFallback:c,usedPreview:o}=await he({preferPreviews:n});if(!i.length){alert("Unable to load frames from disk.");return}const s=i[0].bmp,p=s.width/s.height||1,E=Math.max(1,Math.round(a/p));d("rendering GIF…");const v=document.createElement("canvas");v.width=a,v.height=E;const P=v.getContext("2d"),y=new GIF({workers:2,quality:10,workerScript:C,width:a,height:E}),w=()=>{i.forEach(b=>{b.volatile&&b.bmp?.close&&b.bmp.close()})};try{for(let b=0;b<r;b++)for(const A of i)Z(A.bmp,P,a,E),y.addFrame(P,{copy:!0,delay:e})}catch(b){w(),console.error("GIF export failed",b),alert("GIF export failed. See console for details."),d("GIF failed");return}y.on("finished",b=>{w();const A=URL.createObjectURL(b);Ke(A,`slideshow_${Date.now()}.gif`),d(c?"GIF ready (preview fallback)":o?"GIF ready (preview source)":"GIF ready")}),y.render()}async function Ye(){if(t.frames.length===0){alert("Snap at least 1 frame first.");return}const e=X(),r=Se,a=Math.max(1,Number(Re.value)||1),n=t.frames.length*a;if(n===0){alert("No frames available for export.");return}const{entries:i,usedFallback:c}=await he();if(!i.length){alert("Unable to load frames from disk.");return}d("recording…");const o=!!t.slideshowTimer;D();const s=document.createElement("canvas");s.width=i[0].bmp.width,s.height=i[0].bmp.height;const p=s.getContext("2d"),E=s.captureStream(r),P=["video/mp4;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"].find(h=>MediaRecorder.isTypeSupported(h))||"",y=new MediaRecorder(E,P?{mimeType:P}:void 0),w=[];y.ondataavailable=h=>{h.data&&h.data.size&&w.push(h.data)};const b=new Promise((h,V)=>{y.onstop=h,y.onerror=j=>V(j.error||j)});y.start();const A=Math.max(1,Math.round(e/1e3*r)),Qe=n*A,be=i.map(h=>h.bmp),xe=()=>{i.forEach(h=>{h.volatile&&h.bmp?.close&&h.bmp.close()})};let ie=0;const Xe=Math.max(1,Math.round(1e3/r)),oe=setInterval(()=>{const V=Math.floor(ie/A)%be.length,j=be[V];Z(j,p,s.width,s.height);const Ee=t.frames[V];Ee&&z(Ee),ie++,ie>=Qe&&(clearInterval(oe),y.stop())},Xe);try{await b}catch(h){clearInterval(oe),xe(),console.error("Video export failed",h),alert("Video export failed. See console for details."),d("video failed");return}clearInterval(oe);const W=new Blob(w,{type:y.mimeType||"video/webm"}),Je=/mp4/.test(W.type)?"mp4":"webm",Ze=URL.createObjectURL(W);ye(Ze,`slideshow_${Date.now()}.${Je}`,`${W.type} • ${(W.size/1024/1024).toFixed(2)} MB`),xe(),d(c?"video ready (preview fallback)":"video ready"),o&&t.frames.length>=2&&G()}function Ke(e,r){ye(e,r);const a=document.createElement("a");a.href=e,a.download=r,document.body.appendChild(a),a.click(),a.remove()}function ye(e,r,a=""){const n=document.createElement("div");n.className="glass rounded-xl p-3 flex items-center justify-between";const i=document.createElement("div");i.innerHTML=`<div class="font-medium">${r}</div><div class="text-xs text-white/70">${a}</div>`;const c=document.createElement("div"),o=document.createElement("a");o.href=e,o.download=r,o.className="btn btn-primary",o.textContent="Download",c.appendChild(o),n.appendChild(i),n.appendChild(c),De.prepend(n)}Me.addEventListener("click",Ge),ke.addEventListener("click",$e),H&&(H.addEventListener("click",we),H.addEventListener("keydown",_e)),U&&U.addEventListener("input",ze),T&&(T.addEventListener("click",ge),T.addEventListener("keydown",Ve)),k&&(k.addEventListener("input",ae),k.addEventListener("change",ae)),$&&$.addEventListener("change",ve),f&&f.addEventListener("loadedmetadata",()=>{pe(),ee(),F()},{once:!1}),Ce.addEventListener("click",qe),Ie.addEventListener("click",Ye),J(),L(),ae(),ve(),(async()=>{try{(await navigator.mediaDevices.enumerateDevices()).some(a=>a.kind==="videoinput")&&te()}catch{}})()})();
